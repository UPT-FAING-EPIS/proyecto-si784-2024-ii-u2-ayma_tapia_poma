name: SonarCloud Analysis

on:
  push:
    branches:
      - main

jobs:
  sonarcloud:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up SonarCloud
      uses: SonarSource/sonarcloud-github-action@v2
      with:
        entryPoint: /usr/bin/mvn

    - name: Run SonarCloud Analysis
      run: |
        mvn clean install
        mvn clean verify sonar:sonar -Dsonar.projectKey=erickorganizacion_do-list \
          -Dsonar.organization=erickorganizacion \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=785e43de9ae31633a9e236036130a25b3a33d6a3

    - name: Upload SARIF result to GitHub Code Scanning
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: sonar-report.sarif

    - name: Move SARIF report to 'informes/sonar' folder
      run: |
        mkdir -p informes/sonar
        mv sonar-report.sarif informes/sonar/

    - name: Configure Git for GitHub Pages
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"

    - name: Publish SARIF report to GitHub Pages
      run: |
        git fetch origin gh-pages
        git checkout gh-pages || git checkout --orphan gh-pages
        cp informes/sonar/sonar-report.sarif sonar-report.sarif
        git add sonar-report.sarif
        git commit -m "Publishing SonarCloud SARIF report" || echo "No changes to commit"
        git push origin gh-pages
